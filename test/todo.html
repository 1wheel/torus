<!DOCTYPE html>
<html>
  <head>
    <title>Torus Todo</title>
  </head>
  <body>
    <script src='/torus.js'></script>
    <script>
      class Task extends Record {}
      class TaskStore extends Store {

        initialize() {
          this.recordClass = Task;
        }

      }
      const tasks = new TaskStore([
        new Task(1, {description: 'Do this', completed: false,}),
        new Task(2, {description: 'Do that', completed: false,}),
      ], task => task.get('description'));

      class Item extends Component {

        initialize(source) {
          this.listen({
            source: source,
            handler: data => this.render(data),
          });
        }

        compose(data) {
          return (
            li({}, [
              input({
                type: 'checkbox',
                checked: data.completed,
              }),
              data.description,
            ])
          );
        }

      }

      class List extends Component {

        initialize() {
          this.listen({
            source: tasks,
            handler: this.updateItems.bind(this),
          });

          this.items = new Map();
        }

        updateItems(data) {
          for (const [record, item] of this.items.entries()) {
            if (!data.includes(record)) {
              this.items.delete(record);
            }
          }
          for (const record of data) {
            if (this.items.has(record)) {
              // taken care of, pass
            } else {
              this.items.set(record, new Item(record));
            }
          }

          const sorter = [...this.items.entries()];
          sorter.sort((a, b) => data.indexOf(a[0]) - data.indexOf(b[0]));

          this.items = new Map();
          for (const [record, item] of sorter) {
            this.items.set(record, item);
          }

          this.render();
        }

        compose(data) {
          return (
            ul([...this.items.values()].map(item => item.node))
          );
        }

      }

      class TaskInput extends Component {

        initialize() {
          this.value = '';
          this.boundOnKeyPress = this.onKeyPress.bind(this);
          this.boundOnAddClick = this.onAddClick.bind(this);
          this.boundSetValue = this.setValue.bind(this);
        }

        onKeyPress(evt) {
          if (evt.keyCode === 13) {
            this._addTask();
          }
        }

        onAddClick(evt) {
          this._addTask();
        }

        setValue(evt) {
          this.value = evt.target.value;
        }

        _addTask() {
          tasks.add(new Task(
            undefined,
            {
              description: this.value,
              completed: false,
            }
          ));

          this.value = '';
          this.render();
        }
        
        compose() {
          return (
            div([
              input({
                value: this.value,
              }, {
                keyup: this.boundSetValue,
                keypress: this.boundOnKeyPress,
              }),
              button({}, {
                click: this.boundOnAddClick,
              }, [
                'Add'
              ]),
            ])
          );
        }

      }

      class App extends Component {

        initialize() {
          this.input = new TaskInput();
          this.list = new List();
        }

        compose() {
          return (
            div([
              this.input.node,
              this.list.node,
            ])
          );
        }

      }

      const app = new App();
      document.body.appendChild(app.node);
    </script>
  </body>
</html>


<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>torus.js annotated source</title>
    <link rel="stylesheet" href="main.css">
</head>

<body>
    <main>
        <div class="line">
            <div class="doc">
                <h1>torus.js <span class="fade">annotated source</span></h1>
                <em><a class="back" href="./">Back to index</a></em>
            </div>
            <pre></pre>
        </div>
        <div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">1</strong>// @begindebug</pre></div>
<div class="line"><div class="doc"><p>These utility functions enable rich debugging statements during development, when using the development build (<code>dist/torus.dev.js</code>). These give you hierarchical information about what components are being rendered, and how.</p>
</div><pre class="source javascript"><strong class="lineNumber">6</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>Flag to enable rich debugging during renders</p>
</div><pre class="source javascript"><strong class="lineNumber">8</strong>const DEBUG_RENDER = true;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">9</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">10</strong>const repeat = (str, count) =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">11</strong>    let s = '';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">12</strong>    while (count &#62; 0) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">13</strong>        s += str;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">14</strong>        count --;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">15</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">16</strong>    return s;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">17</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">18</strong></pre></div>
<div class="line"><div class="doc"><p>Main rich debug logger function. <code>render_debug()</code> depends on the <code>render_stack</code> counter in our rendering algorithm to figure out how deep in the render tree we are, and indent the message to the level appropriate to our place in the render tree.</p>
</div><pre class="source javascript"><strong class="lineNumber">24</strong>const render_debug = (msg, header = false) =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">25</strong>    if (DEBUG_RENDER) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">26</strong>        if (header) {</pre></div>
<div class="line"><div class="doc"><p>We want to pull forward headers in front of their section contents, so we de-indent 1.</p>
</div><pre class="source javascript"><strong class="lineNumber">29</strong>            const prefix = repeat('\t', render_stack - 1);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">30</strong>            console.log('%c' + prefix + msg, 'font-weight: bold');</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">31</strong>        } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">32</strong>            const prefix = repeat('\t', render_stack);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">33</strong>            console.log(prefix + msg);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">34</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">35</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">36</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">37</strong>// @enddebug</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">38</strong></pre></div>
<div class="line"><div class="doc"><p>IDL attributes are attributes that are reflected in <code>HTMLElement</code> objects&#39; JavaScript properties. They&#39;re often boolean flags, so they&#39;re easier to set (and sometimes only possible to set) in JS as opposed to using <code>HTMLElement.setAttribute()</code>.</p>
</div><pre class="source javascript"><strong class="lineNumber">43</strong>const HTML_IDL_ATTRIBUTES = [</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">44</strong>    'type',</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">45</strong>    'value',</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">46</strong>    'selected',</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">47</strong>    'indeterminate',</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">48</strong>    'tabIndex',</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">49</strong>    'checked',</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">50</strong>    'disabled',</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">51</strong>];</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">52</strong></pre></div>
<div class="line"><div class="doc"><p>A global counter for how deep we are in our render tree. 0 indicates that we aren&#39;t in the middle of rendering.</p>
</div><pre class="source javascript"><strong class="lineNumber">55</strong>let render_stack = 0;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">56</strong></pre></div>
<div class="line"><div class="doc"><p>Shortcut utility function to check if a given name is bound to something that&#39;s an actual object (not just null)</p>
</div><pre class="source javascript"><strong class="lineNumber">59</strong>const isObject = o =&#62; typeof o === 'object' &#38;&#38; o !== null;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">60</strong></pre></div>
<div class="line"><div class="doc"><p><code>normalizeJDOM</code> takes a JDOM object (dictionary) and modifies it in place so it has the default JDOM properties, and we don&#39;t have to complicate our rendering code by checking for nulls with every key access into our serialized virtual DOM. Note that we don&#39;t check <code>isObject(jdom)</code> here. We assume only valid objects are passed in to &#39;normalize&#39;, which is true in our usage so far. <code>normalizeJDOM</code> is a hot path in rendering, so we need it as fast as it can be.</p>
</div><pre class="source javascript"><strong class="lineNumber">69</strong>const normalizeJDOM = jdom =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">70</strong>    if (!('tag' in jdom)) jdom.tag = 'div';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">71</strong>    if (!('attrs' in jdom)) jdom.attrs = {};</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">72</strong>    if (!('events' in jdom)) jdom.events = {};</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">73</strong>    if (!('children' in jdom)) jdom.children = [];</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">74</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">75</strong></pre></div>
<div class="line"><div class="doc"><p>Quick shorthand to normalize either 1. a single value or 2. an array of values into an array of values. This is useful because JDOM accepts either into things like <code>attrs.class</code> and <code>events.&lt;name&gt;</code>.</p>
</div><pre class="source javascript"><strong class="lineNumber">79</strong>const arrayNormalize = data =&#62; data instanceof Array ? data : [data];</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">80</strong></pre></div>
<div class="line"><div class="doc"><p>We use comment nodes as placeholder nodes because they&#39;re lightweight and invisible.</p>
</div><pre class="source javascript"><strong class="lineNumber">83</strong>const tmpNode = () =&#62; document.createComment('');</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">84</strong></pre></div>
<div class="line"><div class="doc"><p><code>placeholders</code> is a global unordered queue of placeholders and the nodes they&#39;re place-holding for. While rendering, we use placeholders to insert or move around any nodes to avoid multi-insertion conflicts. At the end of each render (when <code>render_stack</code> is 0), we replace all placeholders to the DOM before the browser renders the next frame in one fell swoop.</p>
</div><pre class="source javascript"><strong class="lineNumber">90</strong>const placeholders = new Map();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">91</strong>function replacePlaceholders() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">92</strong>    for (const [tmp, newNode] of placeholders.entries()) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">93</strong>        tmp.parentNode.replaceChild(newNode, tmp);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">94</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">95</strong>    placeholders.clear();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">96</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">97</strong></pre></div>
<div class="line"><div class="doc"><p>Torus&#39;s virtual DOM rendering algorithm that manages all diffing, updating, and efficient DOM access. <code>renderJDOM</code> takes <code>node</code>, the previous root node; <code>previous</code>, the previous JDOM; and <code>next</code>, the new JDOM; and returns the new root node (potentially different from the old root node.) Whenever a component is rendered, it calls <code>renderJDOM</code>. This rendering algorithm is recursive into child nodes.</p>
</div><pre class="source javascript"><strong class="lineNumber">104</strong>const renderJDOM = (node, previous, next) =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">105</strong></pre></div>
<div class="line"><div class="doc"><p>This queues up a node to be inserted into a new slot in the DOM tree. All queued replacements will flush to DOM at the end of the render pass, from <code>placeholders</code>.</p>
</div><pre class="source javascript"><strong class="lineNumber">109</strong>    function replacePreviousNode(newNode) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">110</strong>        if (node !== undefined &#38;&#38; node !== newNode &#38;&#38; node.parentNode) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">111</strong>            const tmp = tmpNode();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">112</strong>            placeholders.set(tmp, newNode);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">113</strong>            node.parentNode.replaceChild(tmp, node);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">114</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">115</strong>        node = newNode;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">116</strong>    };</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">117</strong></pre></div>
<div class="line"><div class="doc"><p>We&#39;re rendering a new node in the render tree. Increment counter.</p>
</div><pre class="source javascript"><strong class="lineNumber">119</strong>    render_stack ++;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">120</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">121</strong>    const isChanged = previous !== next;</pre></div>
<div class="line"><div class="doc"><p>If we need to render a literal DOM Node, just replace the old node with the literal node.</p>
</div><pre class="source javascript"><strong class="lineNumber">124</strong>    if (isChanged &#38;&#38; next instanceof Node) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">125</strong>        // @begindebug</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">126</strong>        if (node === undefined) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">127</strong>            render_debug(`Add literal element &#60;${next.tagName}&#62;`);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">128</strong>        } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">129</strong>            render_debug(`Replace literal element &#60;${previous.tagName}&#62; with literal element &#60;${next.tagName}&#62;`);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">130</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">131</strong>        // @enddebug</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">132</strong>        replacePreviousNode(next);</pre></div>
<div class="line"><div class="doc"><p>If we need to render a null (comment) node, create and insert a comment node. This might seem silly, but it keeps the DOM consistent between renders and makes diff simpler.</p>
</div><pre class="source javascript"><strong class="lineNumber">137</strong>    } else if (isChanged &#38;&#38; next === null) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">138</strong>        // @begindebug</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">139</strong>        if (node === undefined) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">140</strong>            render_debug('Add comment node');</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">141</strong>        } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">142</strong>            render_debug(`Replace previous node &#60;${node.tagName}&#62; with comment node`);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">143</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">144</strong>        // @enddebug</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">145</strong>        replacePreviousNode(tmpNode());</pre></div>
<div class="line"><div class="doc"><p>If we&#39;re rendering a string or raw number, convert it into a string and add a TextNode.</p>
</div><pre class="source javascript"><strong class="lineNumber">148</strong>    } else if (isChanged &#38;&#38; (typeof next === 'string' || typeof next === 'number')) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">149</strong>        // @begindebug</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">150</strong>        if (node === undefined) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">151</strong>            render_debug(`Add text node "${next}"`);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">152</strong>        } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">153</strong>            render_debug(`Replace previous node "${previous}" with text node "${next}"`);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">154</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">155</strong>        // @enddebug</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">156</strong>        replacePreviousNode(document.createTextNode(next));</pre></div>
<div class="line"><div class="doc"><p>If we&#39;re rendering an object literal, assume it&#39;s a serialized JDOM dictionary. This is the meat of the algorithm.</p>
</div><pre class="source javascript"><strong class="lineNumber">159</strong>    } else if (typeof next === 'object') {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">160</strong>        if (previous === undefined) {</pre></div>
<div class="line"><div class="doc"><p>If the previous JDOM doesn&#39;t exist, we&#39;re adding a completely new node into the DOM. Stub an empty <code>previous</code>.</p>
</div><pre class="source javascript"><strong class="lineNumber">163</strong>            previous = {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">164</strong>                tag: null,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">165</strong>            };</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">166</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">167</strong>        normalizeJDOM(previous);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">168</strong>        normalizeJDOM(next);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">169</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">170</strong>        // @debug</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">171</strong>        render_debug(`Render pass for &#60;${next.tag.toLowerCase()}&#62;:`, true);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">172</strong></pre></div>
<div class="line"><div class="doc"><p>If the tags differ, we assume the subtrees will be different as well and just start a completely new element. This is efficient in practice, reduces the time complexity of the algorithm, and an optimization shared with React&#39;s reconciler.</p>
</div><pre class="source javascript"><strong class="lineNumber">177</strong>        if (previous.tag !== next.tag) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">178</strong>            if (node === undefined) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">179</strong>                // @debug</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">180</strong>                render_debug(`Add &#60;${next.tag}&#62;`);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">181</strong>            } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">182</strong>                // @debug</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">183</strong>                render_debug(`Replace previous node &#60;${node.tagName}&#62; with &#60;${next.tag}`);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">184</strong>                // new root element, so "reset" previous</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">185</strong>                previous = {};</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">186</strong>                normalizeJDOM(previous);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">187</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">188</strong>            replacePreviousNode(document.createElement(next.tag));</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">189</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">190</strong></pre></div>
<div class="line"><div class="doc"><p>Compare and update attributes</p>
</div><pre class="source javascript"><strong class="lineNumber">192</strong>        for (const attrName in next.attrs) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">193</strong>            switch (attrName) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">194</strong>                case 'class':</pre></div>
<div class="line"><div class="doc"><p>JDOM can pass classes as either a single string or an array of strings, so normalize it into an array.</p>
</div><pre class="source javascript"><strong class="lineNumber">197</strong>                    const prevClass = arrayNormalize(previous.attrs.class || []);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">198</strong>                    const nextClass = arrayNormalize(next.attrs.class);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">199</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">200</strong>                    for (const className of nextClass) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">201</strong>                        // @debug</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">202</strong>                        render_debug(`Add &#60;${next.tag}&#62; class "${className}"`);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">203</strong>                        node.classList.add(className);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">204</strong>                    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">205</strong>                    for (const className of prevClass) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">206</strong>                        if (!nextClass.includes(className)) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">207</strong>                            // @debug</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">208</strong>                            render_debug(`Remove &#60;${next.tag}&#62; class "${className}"`);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">209</strong>                            node.classList.remove(className);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">210</strong>                        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">211</strong>                    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">212</strong>                    break;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">213</strong>                case 'style':</pre></div>
<div class="line"><div class="doc"><p>JDOM takes style attributes as a dictionary rather than a string for API ergonomics, so we serialize it differently than other attributes.</p>
</div><pre class="source javascript"><strong class="lineNumber">217</strong>                    const prevStyle = previous.attrs.style || {};</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">218</strong>                    const nextStyle = next.attrs.style;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">219</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">220</strong>                    for (const styleKey in nextStyle) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">221</strong>                        if (nextStyle[styleKey] !== prevStyle[styleKey]) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">222</strong>                            // @debug</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">223</strong>                            render_debug(`Set &#60;${next.tag}&#62; style ${styleKey}: ${nextStyle[styleKey]}`);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">224</strong>                            node.style[styleKey] = nextStyle[styleKey];</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">225</strong>                        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">226</strong>                    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">227</strong>                    for (const styleKey in prevStyle) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">228</strong>                        if (!(styleKey in next.attrs.style)) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">229</strong>                            // @debug</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">230</strong>                            render_debug(`Unsetting &#60;${next.tag}&#62; style ${styleKey}: ${prevStyle[styleKey]}`);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">231</strong>                            node.style[styleKey] = '';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">232</strong>                        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">233</strong>                    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">234</strong>                    break;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">235</strong>                default:</pre></div>
<div class="line"><div class="doc"><p>If an attribute is an IDL attribute, we set it through JavaScript properties on the HTML element and not <code>setAttribute()</code>. This is necessary for properties like <code>value</code> and <code>indeterminate</code>.</p>
</div><pre class="source javascript"><strong class="lineNumber">240</strong>                    if (HTML_IDL_ATTRIBUTES.includes(attrName)) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">241</strong>                        // @debug</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">242</strong>                        render_debug(`Set &#60;${next.tag}&#62; property ${attrName} = ${next.attrs[attrName]}`);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">243</strong>                        node[attrName] = next.attrs[attrName];</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">244</strong>                    } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">245</strong>                        if (next.attrs[attrName] !== previous.attrs[attrName]) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">246</strong>                            // @debug</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">247</strong>                            render_debug(`Set &#60;${next.tag}&#62; attribute "${attrName}" to "${next.attrs[attrName]}"`);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">248</strong>                            node.setAttribute(attrName, next.attrs[attrName]);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">249</strong>                        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">250</strong>                    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">251</strong>                    break;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">252</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">253</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">254</strong>        }</pre></div>
<div class="line"><div class="doc"><p>For any attributes that were removed in the new JDOM, also attempt to remove them from the DOM.</p>
</div><pre class="source javascript"><strong class="lineNumber">257</strong>        for (const attrName in previous.attrs) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">258</strong>            if (!(attrName in next.attrs)) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">259</strong>                if (HTML_IDL_ATTRIBUTES.includes(attrName)) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">260</strong>                    // @debug</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">261</strong>                    render_debug(`Remove &#60;${next.tag} property ${attrName}`);</pre></div>
<div class="line"><div class="doc"><p><code>null</code> seems to be the default for most IDL attrs, but even this isn&#39;t entirely consistent. This seems like something we should fix as issues come up, not preemptively search for a cross-browser solution.</p>
</div><pre class="source javascript"><strong class="lineNumber">266</strong>                    node[attrName] = null;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">267</strong>                } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">268</strong>                    // @debug</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">269</strong>                    render_debug(`Remove &#60;${next.tag}&#62; attribute ${attrName}`);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">270</strong>                    node.removeAttribute(attrName);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">271</strong>                }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">272</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">273</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">274</strong></pre></div>
<div class="line"><div class="doc"><p>Compare event handlers</p>
</div><pre class="source javascript"><strong class="lineNumber">276</strong>        const diffEvents = (whole, sub, cb) =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">277</strong>            for (const eventName in whole) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">278</strong>                const wholeEvents = arrayNormalize(whole[eventName] || []);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">279</strong>                const subEvents = arrayNormalize(sub[eventName]);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">280</strong>                for (const handlerFn of wholeEvents) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">281</strong>                    if (!subEvents.includes(handlerFn)) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">282</strong>                        cb(eventName, handlerFn);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">283</strong>                    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">284</strong>                }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">285</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">286</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">287</strong>        diffEvents(next.events, previous.events, (eventName, handlerFn) =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">288</strong>            // @debug</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">289</strong>            render_debug(`Set new ${eventName} event listener on &#60;${next.tag}&#62;`);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">290</strong>            node.addEventListener(eventName, handlerFn);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">291</strong>        });</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">292</strong>        diffEvents(previous.events, next.events, (eventName, handlerFn) =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">293</strong>            // @debug</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">294</strong>            render_debug(`Remove ${eventName} event listener on &#60;${next.tag}&#62;`);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">295</strong>            node.removeEventListener(eventName, handlerFn);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">296</strong>        });</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">297</strong></pre></div>
<div class="line"><div class="doc"><p>Render children recursively</p>
</div><pre class="source javascript"><strong class="lineNumber">299</strong>        const nodeChildren = node.childNodes;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">300</strong>        const prevChildren = previous.children;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">301</strong>        const nextChildren = next.children;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">302</strong>        if (nextChildren.length + prevChildren.length &#62; 0) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">303</strong>            if (prevChildren.length &#60; nextChildren.length) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">304</strong>                let i;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">305</strong>                for (i = 0; i &#60; prevChildren.length; i ++) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">306</strong>                    renderJDOM(nodeChildren[i], prevChildren[i], nextChildren[i]);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">307</strong>                }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">308</strong>                while (i &#60; nextChildren.length) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">309</strong>                    node.appendChild(renderJDOM(undefined, undefined, nextChildren[i]));</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">310</strong>                    i ++;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">311</strong>                }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">312</strong>            } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">313</strong>                let i;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">314</strong>                for (i = 0; i &#60; nextChildren.length; i ++) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">315</strong>                    renderJDOM(nodeChildren[i], prevChildren[i], nextChildren[i]);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">316</strong>                }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">317</strong>                while (i &#60; prevChildren.length) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">318</strong>                    // @debug</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">319</strong>                    render_debug(`Remove child &#60;${nodeChildren[i].tagName}&#62;`);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">320</strong>                    node.removeChild(nodeChildren[i]);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">321</strong>                    i ++;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">322</strong>                }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">323</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">324</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">325</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">326</strong></pre></div>
<div class="line"><div class="doc"><p>We&#39;re done rendering the current node, so decrement the render stack.</p>
</div><pre class="source javascript"><strong class="lineNumber">329</strong>    render_stack --;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">330</strong></pre></div>
<div class="line"><div class="doc"><p>If we&#39;ve reached the top of the render tree, it&#39;s time to flush replaced nodes to the DOM before the next frame.</p>
</div><pre class="source javascript"><strong class="lineNumber">333</strong>    if (render_stack === 0) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">334</strong>        replacePlaceholders();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">335</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">336</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">337</strong>    return node;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">338</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">339</strong></pre></div>
<div class="line"><div class="doc"><p>Shorthand function for the default, empty event object in <code>Component</code>.</p>
</div><pre class="source javascript"><strong class="lineNumber">341</strong>const emptyEvent = () =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">342</strong>    return {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">343</strong>        source: null,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">344</strong>        handler: () =&#62; { },</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">345</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">346</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">347</strong></pre></div>
<div class="line"><div class="doc"><p>Torus&#39;s Component class</p>
</div><pre class="source javascript"><strong class="lineNumber">349</strong>class Component {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">350</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">351</strong>    constructor(...args) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">352</strong>        this.jdom = undefined;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">353</strong>        this.node = undefined;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">354</strong>        this.event = emptyEvent();</pre></div>
<div class="line"><div class="doc"><p>We call init() before render, because it&#39;s a common pattern to set and initialize &quot;private&quot; fields in <code>this.init()</code> (at least before the ES-next private fields proposal becomes widely supported.) Frequently, rendering will require private values to be set correctly.</p>
</div><pre class="source javascript"><strong class="lineNumber">359</strong>        this.init(...args);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">360</strong>        this.render();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">361</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">362</strong></pre></div>
<div class="line"><div class="doc"><p><code>Component.from()</code> allows us to transform a pure function that maps arguments to a JDOM tree, and promote it into a full-fledged <code>Component</code> class we can compose and use anywhere.</p>
</div><pre class="source javascript"><strong class="lineNumber">366</strong>    static from(fn) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">367</strong>        return class FunctionComponent extends Component {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">368</strong>            init(...args) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">369</strong>                this.args = args;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">370</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">371</strong>            compose() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">372</strong>                return fn(...this.args);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">373</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">374</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">375</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">376</strong></pre></div>
<div class="line"><div class="doc"><p>The default <code>Component#init()</code> is guaranteed to always be a no-op method</p>
</div><pre class="source javascript"><strong class="lineNumber">378</strong>    init() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">379</strong>        // should be overridden</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">380</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">381</strong></pre></div>
<div class="line"><div class="doc"><p>Components usually subscribe to events from a Record, either a view model or a model that maps to business logic. This is shorthand to access that.</p>
</div><pre class="source javascript"><strong class="lineNumber">384</strong>    get record() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">385</strong>        return this.event.source;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">386</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">387</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">388</strong>    bind(source, handler) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">389</strong>        this.unbind();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">390</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">391</strong>        if (source instanceof Evented) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">392</strong>            this.event = {source, handler};</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">393</strong>            source.addHandler(handler);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">394</strong>        } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">395</strong>            throw new Error('Event source to bind() to is not an instance of Evented');</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">396</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">397</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">398</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">399</strong>    unbind() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">400</strong>        if (this.record) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">401</strong>            this.record.removeHandler(this.event.handler);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">402</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">403</strong>        this.event = emptyEvent();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">404</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">405</strong></pre></div>
<div class="line"><div class="doc"><p>We use <code>#remove()</code> to prepare to remove the component from our application entirely. By default, it unsubscribes from all updates. However, the component is still in the render tree -- that&#39;s something for the user to decide when to hide.</p>
</div><pre class="source javascript"><strong class="lineNumber">410</strong>    remove() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">411</strong>        this.unbind();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">412</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">413</strong></pre></div>
<div class="line"><div class="doc"><p><code>#compose()</code> is our primary rendering API for components. By default, it renders an invisible comment node.</p>
</div><pre class="source javascript"><strong class="lineNumber">416</strong>    compose(data) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">417</strong>        return null;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">418</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">419</strong></pre></div>
<div class="line"><div class="doc"><p><code>#preprocess()</code> is an API on the component to allow us to extend <code>Component</code> to give it additional capabilities idiomatically. It consumes the result of <code>#compose()</code> and returns JDOM to be used to actually render the component. See <code>Styled()</code> for a usage example -- it fills similar use cases as React&#39;s render props or HOCs.</p>
</div><pre class="source javascript"><strong class="lineNumber">424</strong>    preprocess(jdom, data) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">425</strong>        return jdom;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">426</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">427</strong></pre></div>
<div class="line"><div class="doc"><p><code>#render()</code> is called to actually render the component again to the DOM, and Torus assumes that it&#39;s called rarely, only when the component absolutely must update. This obviates the need for something like React&#39;s <code>shouldComponentUpdate</code>.</p>
</div><pre class="source javascript"><strong class="lineNumber">431</strong>    render(data) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">432</strong>        // @debug</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">433</strong>        render_debug(`Render Component: ${this.constructor.name}`, true);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">434</strong>        data = data || (this.record &#38;&#38; this.record.summarize())</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">435</strong>        const jdom = this.preprocess(this.compose(data), data);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">436</strong>        this.node = renderJDOM(this.node, this.jdom, jdom);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">437</strong>        this.jdom = jdom;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">438</strong>        return this.jdom;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">439</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">440</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">441</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">442</strong></pre></div>
<div class="line"><div class="doc"><p>We keep track of unique class names already injected into the page&#39;s stylesheet, so we don&#39;t do redundant style reconciliation.</p>
</div><pre class="source javascript"><strong class="lineNumber">445</strong>const injectedClassNames = new Set();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">446</strong></pre></div>
<div class="line"><div class="doc"><p>Global pointer to the stylesheet on the page that Torus uses to insert new CSS rules. It&#39;s set the first time a styled component renders.</p>
</div><pre class="source javascript"><strong class="lineNumber">449</strong>let styledComponentSheet = null;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">450</strong></pre></div>
<div class="line"><div class="doc"><p>Fast pure function to map a style rule to a very reasonably unique class name that won&#39;t conflict with other classes on the page.</p>
</div><pre class="source javascript"><strong class="lineNumber">453</strong>const generateUniqueClassName = stylesObject =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">454</strong>    // Modified from https://github.com/darkskyapp/string-hash/blob/master/index.js</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">455</strong>    const str = JSON.stringify(stylesObject).replace(/\s+/g, ' ');</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">456</strong>    let i = str.length;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">457</strong>    let hash = 1989;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">458</strong>    while (i) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">459</strong>        hash = (hash * 13) ^ str.charCodeAt(--i);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">460</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">461</strong>    return '_torus' + (hash &#62;&#62;&#62; 0);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">462</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">463</strong></pre></div>
<div class="line"><div class="doc"><p>We have to construct lots of a{b} syntax in CSS, so here&#39;s a shorthand.</p>
</div><pre class="source javascript"><strong class="lineNumber">465</strong>const brace = (a, b) =&#62; a + '{' + b + '}';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">466</strong></pre></div>
<div class="line"><div class="doc"><p>The meat of <code>Styled()</code>. This function maps an ergonomic, dictionary-based set of CSS declarations to an array of CSS rules that can be inserted onto the page stylesheet, and recursively resolves nested CSS, handles keyframes and media queries, and parses other SCSS-like things.</p>
</div><pre class="source javascript"><strong class="lineNumber">471</strong>const rulesFromStylesObject = (selector, stylesObject) =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">472</strong>    let rules = [];</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">473</strong>    let selfDeclarations = '';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">474</strong>    for (const [prop, val] of Object.entries(stylesObject)) {</pre></div>
<div class="line"><div class="doc"><p>CSS declarations that start with &#39;@&#39; are globally namespaced (like @keyframes and @media), so we need to treat them differently.</p>
</div><pre class="source javascript"><strong class="lineNumber">477</strong>        if (prop[0] === '@') {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">478</strong>            if (prop.startsWith('@media')) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">479</strong>                rules.push(brace(prop, rulesFromStylesObject(selector, val).join('')));</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">480</strong>            } else  { // @keyframes or @font-face</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">481</strong>                rules.push(brace(prop, rulesFromStylesObject('', val).join('')));</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">482</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">483</strong>        } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">484</strong>            if (typeof val === 'object') {</pre></div>
<div class="line"><div class="doc"><p>SCSS-like syntax means we use &#39;&amp;&#39; to nest declarations about the parent selector.</p>
</div><pre class="source javascript"><strong class="lineNumber">487</strong>                if (prop.includes('&#38;')) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">488</strong>                    const fullSelector = prop.replace(/&#38;/g, selector);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">489</strong>                    rules = rules.concat(rulesFromStylesObject(fullSelector, val));</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">490</strong>                } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">491</strong>                    rules = rules.concat(rulesFromStylesObject(selector + ' ' + prop, val));</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">492</strong>                }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">493</strong>            } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">494</strong>                selfDeclarations += prop + ':' + val + ';';</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">495</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">496</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">497</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">498</strong>    if (selfDeclarations) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">499</strong>        rules.push(brace(selector, selfDeclarations));</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">500</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">501</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">502</strong>    return rules;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">503</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">504</strong></pre></div>
<div class="line"><div class="doc"><p>Function called once to initialize a stylesheet for Torus to use on every subsequent style render.</p>
</div><pre class="source javascript"><strong class="lineNumber">507</strong>const initSheet = () =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">508</strong>    styleElement = document.createElement('style');</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">509</strong>    styleElement.setAttribute('data-torus', '');</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">510</strong>    document.head.appendChild(styleElement);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">511</strong>    styledComponentSheet = styleElement.sheet;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">512</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">513</strong></pre></div>
<div class="line"><div class="doc"><p>The preprocessor on <code>Styled()</code> components call this to make sure a given set of CSS rules for a component is inserted into the page stylesheet, but only once for a unique set of rules. We disambiguate by the class name, which is a hash of the CSS rules.</p>
</div><pre class="source javascript"><strong class="lineNumber">518</strong>const injectStylesOnce = stylesObject =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">519</strong>    const className = generateUniqueClassName(stylesObject);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">520</strong>    if (!injectedClassNames.has(className)) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">521</strong>        if (!styledComponentSheet) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">522</strong>            initSheet();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">523</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">524</strong>        const rules = rulesFromStylesObject('.' + className, stylesObject);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">525</strong>        for (const rule of rules) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">526</strong>            // @debug</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">527</strong>            render_debug(`Add new CSS rule: ${rule}`);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">528</strong>            styledComponentSheet.insertRule(rule, styledComponentSheet.cssRules.length);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">529</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">530</strong>        injectedClassNames.add(className);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">531</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">532</strong>    return className;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">533</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">534</strong></pre></div>
<div class="line"><div class="doc"><p>Higher-order component to enable styling for any Component class.</p>
</div><pre class="source javascript"><strong class="lineNumber">536</strong>const Styled = Base =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">537</strong>    return class extends Base {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">538</strong>        styles(data) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">539</strong>            return {};</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">540</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">541</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">542</strong>        preprocess(jdom, data) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">543</strong>            if (isObject(jdom)) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">544</strong>                jdom.attrs = jdom.attrs || {};</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">545</strong>                jdom.attrs.class = arrayNormalize(jdom.attrs.class || []);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">546</strong>                jdom.attrs.class.push(injectStylesOnce(this.styles(data)));</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">547</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">548</strong>            return jdom;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">549</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">550</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">551</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">552</strong></pre></div>
<div class="line"><div class="doc"><p>Provide a default, <code>StyledComponent</code> class</p>
</div><pre class="source javascript"><strong class="lineNumber">554</strong>const StyledComponent = Styled(Component);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">555</strong></pre></div>
<div class="line"><div class="doc"><p>Torus&#39;s generic List implementation, based on Stores</p>
</div><pre class="source javascript"><strong class="lineNumber">557</strong>class List extends Component {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">558</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">559</strong>    get itemClass() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">560</strong>        return Component; // default value, should be overridden</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">561</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">562</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">563</strong>    init(store) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">564</strong>        this.store = store;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">565</strong>        this.items = new Map();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">566</strong>        this.filterFn = null;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">567</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">568</strong>        this.bind(this.store, () =&#62; this.itemsChanged());</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">569</strong>        this.itemsChanged();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">570</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">571</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">572</strong>    itemsChanged() {</pre></div>
<div class="line"><div class="doc"><p>For every record in the store, if it isn&#39;t already in <code>this.items</code>, add it and its view; if any were removed, also remove it from <code>this.items</code>.</p>
</div><pre class="source javascript"><strong class="lineNumber">576</strong>        const data = this.store.summarize();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">577</strong>        for (const record of this.items.keys()) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">578</strong>            if (!data.includes(record)) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">579</strong>                this.items.get(record).remove();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">580</strong>                this.items.delete(record);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">581</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">582</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">583</strong>        for (const record of data) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">584</strong>            if (!this.items.has(record)) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">585</strong>                this.items.set(record, new this.itemClass(record));</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">586</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">587</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">588</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">589</strong>        let sorter = [...this.items.entries()];</pre></div>
<div class="line"><div class="doc"><p>Sort by the provided filter function if there is one</p>
</div><pre class="source javascript"><strong class="lineNumber">591</strong>        if (this.filterFn !== null) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">592</strong>            sorter = sorter.filter(item =&#62; this.filterFn(item[0]));</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">593</strong>        }</pre></div>
<div class="line"><div class="doc"><p>Sort the list the way the associated Store is sorted.</p>
</div><pre class="source javascript"><strong class="lineNumber">595</strong>        sorter.sort((a, b) =&#62; data.indexOf(a[0]) - data.indexOf(b[0]));</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">596</strong></pre></div>
<div class="line"><div class="doc"><p>Store the new items in a new (insertion-ordered) Map at this.items</p>
</div><pre class="source javascript"><strong class="lineNumber">598</strong>        this.items = new Map(sorter);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">599</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">600</strong>        this.render();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">601</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">602</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">603</strong>    filter(filterFn) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">604</strong>        this.filterFn = filterFn;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">605</strong>        this.itemsChanged();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">606</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">607</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">608</strong>    unfilter() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">609</strong>        this.filterFn = null;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">610</strong>        this.itemsChanged();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">611</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">612</strong></pre></div>
<div class="line"><div class="doc"><p><code>List#nodes</code> returns the HTML nodes for each of its item views, sorted in order. Designed to make writing <code>#compose()</code> easier.</p>
</div><pre class="source javascript"><strong class="lineNumber">615</strong>    get nodes() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">616</strong>        return [...this.items.values()].map(item =&#62; item.node);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">617</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">618</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">619</strong>    remove() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">620</strong>        super.remove();</pre></div>
<div class="line"><div class="doc"><p>When we remove a list, we also want to call <code>remove()</code> on each child components.</p>
</div><pre class="source javascript"><strong class="lineNumber">623</strong>        for (const c of this.items.values()) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">624</strong>            c.remove();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">625</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">626</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">627</strong></pre></div>
<div class="line"><div class="doc"><p>By default, just render the children views in a <ul/></p>
</div><pre class="source javascript"><strong class="lineNumber">629</strong>    compose(data) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">630</strong>        return {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">631</strong>            tag: 'ul',</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">632</strong>            children: this.nodes,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">633</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">634</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">635</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">636</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">637</strong></pre></div>
<div class="line"><div class="doc"><p>Higher-order component to create a list component for a given child item component.</p>
</div><pre class="source javascript"><strong class="lineNumber">640</strong>const ListOf = itemClass =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">641</strong>    return class extends List {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">642</strong>        get itemClass() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">643</strong>            return itemClass;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">644</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">645</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">646</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">647</strong></pre></div>
<div class="line"><div class="doc"><p>A base class for evented data stores. Not exposed to the public API, but all observables in Torus inherit from <code>Evented</code>.</p>
</div><pre class="source javascript"><strong class="lineNumber">650</strong>class Evented {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">651</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">652</strong>    constructor() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">653</strong>        this.eventTargets = new Set();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">654</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">655</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">656</strong>    summarize() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">657</strong>        throw new Error(`#summarize() not implemented in ${this.constructor.name}`);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">658</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">659</strong></pre></div>
<div class="line"><div class="doc"><p>Whenever something changes, we fire an event to all subscribed listeners, with a summary of its state.</p>
</div><pre class="source javascript"><strong class="lineNumber">662</strong>    emitEvent() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">663</strong>        const summary = this.summarize();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">664</strong>        for (const handler of this.eventTargets) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">665</strong>            handler(summary);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">666</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">667</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">668</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">669</strong>    addHandler(handler) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">670</strong>        this.eventTargets.add(handler);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">671</strong>        handler(this.summarize());</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">672</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">673</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">674</strong>    removeHandler(handler) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">675</strong>        this.eventTargets.delete(handler);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">676</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">677</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">678</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">679</strong></pre></div>
<div class="line"><div class="doc"><p><code>Record</code> is Torus&#39;s unit of individual data source, used for view models and Models from business logic.</p>
</div><pre class="source javascript"><strong class="lineNumber">682</strong>class Record extends Evented {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">683</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">684</strong>    constructor(id, data = {}) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">685</strong>        super();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">686</strong></pre></div>
<div class="line"><div class="doc"><p>We can create a Record by either passing in just the properties, or an ID and a dictionary of props. We disambiguate here.</p>
</div><pre class="source javascript"><strong class="lineNumber">689</strong>        if (typeof id === 'object' &#38;&#38; !Object.keys(data).length) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">690</strong>            data = id;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">691</strong>            id = null;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">692</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">693</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">694</strong>        this.id = id;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">695</strong>        this.data = data;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">696</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">697</strong></pre></div>
<div class="line"><div class="doc"><p>Setter for properties</p>
</div><pre class="source javascript"><strong class="lineNumber">699</strong>    update(data) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">700</strong>        Object.assign(this.data, data);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">701</strong>        this.emitEvent();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">702</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">703</strong></pre></div>
<div class="line"><div class="doc"><p>Getter</p>
</div><pre class="source javascript"><strong class="lineNumber">705</strong>    get(name) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">706</strong>        return this.data[name];</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">707</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">708</strong></pre></div>
<div class="line"><div class="doc"><p>We summarize a Record by returning a dictionary of all of its properties and the ID</p>
</div><pre class="source javascript"><strong class="lineNumber">711</strong>    summarize() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">712</strong>        return Object.assign(</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">713</strong>            {},</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">714</strong>            this.data,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">715</strong>            {id: this.id}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">716</strong>        );</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">717</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">718</strong></pre></div>
<div class="line"><div class="doc"><p>The JSON-serialized version of a Record is the same as its summary, since it&#39;s a shallow data store with just plain properties.</p>
</div><pre class="source javascript"><strong class="lineNumber">721</strong>    serialize() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">722</strong>        return this.summarize();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">723</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">724</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">725</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">726</strong></pre></div>
<div class="line"><div class="doc"><p>A list of Records, represents a collection or a table</p>
</div><pre class="source javascript"><strong class="lineNumber">728</strong>class Store extends Evented {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">729</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">730</strong>    constructor(records = []) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">731</strong>        super();</pre></div>
<div class="line"><div class="doc"><p>Internally, we represent the store as an unordered set. we only order by comparator when we summarize. This prevents us from having to perform sorting checks on every insert/update, and is efficient as long as we don&#39;t re-render excessively.</p>
</div><pre class="source javascript"><strong class="lineNumber">736</strong>        this.records = new Set(records);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">737</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">738</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">739</strong>    get recordClass() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">740</strong>        return Record;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">741</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">742</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">743</strong>    get comparator() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">744</strong>        return null;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">745</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">746</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">747</strong>    create(id, data) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">748</strong>        this.add(new this.recordClass(id, data));</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">749</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">750</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">751</strong>    add(record) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">752</strong>        this.records.add(record);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">753</strong>        this.emitEvent();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">754</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">755</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">756</strong>    remove(record) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">757</strong>        this.records.delete(record);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">758</strong>        this.emitEvent();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">759</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">760</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">761</strong>    summarize() {</pre></div>
<div class="line"><div class="doc"><p>The summary of a store is defined functionally. We just sort the records in our store by the comparator (but we use a list of pairs of cached comparators and records to be fast.</p>
</div><pre class="source javascript"><strong class="lineNumber">765</strong>        return [...this.records].map(record =&#62; [</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">766</strong>            this.comparator ? this.comparator(record) : null,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">767</strong>            record,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">768</strong>        ]).sort((a, b) =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">769</strong>            if (a[0] &#60; b[0]) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">770</strong>                return -1;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">771</strong>            } else if (a[0] &#62; b[0]) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">772</strong>                return 1;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">773</strong>            } else {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">774</strong>                return 0;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">775</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">776</strong>        }).map(o =&#62; o[1]);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">777</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">778</strong></pre></div>
<div class="line"><div class="doc"><p>To serialize a store, we serialize each record and put them in a giant list.</p>
</div><pre class="source javascript"><strong class="lineNumber">781</strong>    serialize() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">782</strong>        return this.summarize().map(record =&#62; record.serialize());</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">783</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">784</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">785</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">786</strong></pre></div>
<div class="line"><div class="doc"><p>Higher-order component to create a Store for a given record class.</p>
</div><pre class="source javascript"><strong class="lineNumber">789</strong>const StoreOf = recordClass =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">790</strong>    return class extends Store {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">791</strong>        get recordClass() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">792</strong>            return recordClass;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">793</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">794</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">795</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">796</strong></pre></div>
<div class="line"><div class="doc"><p>Helper function for the router. It takes a route string that contains parameters like, <code>/path/:param1/path/:param2</code> and returns a regular expression to match that route and a list of params in that route.</p>
</div><pre class="source javascript"><strong class="lineNumber">801</strong>const routeStringToRegExp = route =&#62; {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">802</strong>    let match;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">803</strong>    const paramNames = [];</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">804</strong>    while (match !== null) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">805</strong>        match = (/:\w+/).exec(route);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">806</strong>        if (match) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">807</strong>            const paramName = match[0];</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">808</strong>            paramNames.push(paramName.substr(1));</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">809</strong>            route = route.replace(paramName, '(.*)');</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">810</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">811</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">812</strong>    return [new RegExp(route), paramNames];</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">813</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">814</strong></pre></div>
<div class="line"><div class="doc"><p>Front-end router. A routing component can bind to updates from the Router instead of a Record, and re-render different subviews when the routes change.</p>
</div><pre class="source javascript"><strong class="lineNumber">818</strong>class Router extends Evented {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">819</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">820</strong>    constructor(routes) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">821</strong>        super();</pre></div>
<div class="line"><div class="doc"><p>We parse the given dictionary of routes into three things: the name of the route, the route regular expression, and the list of params in that route.</p>
</div><pre class="source javascript"><strong class="lineNumber">825</strong>        this.routes = Object.entries(routes)</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">826</strong>            .map(([name, route]) =&#62; [name, ...routeStringToRegExp(route)]);</pre></div>
<div class="line"><div class="doc"><p>Last matched route&#39;s information is cached here</p>
</div><pre class="source javascript"><strong class="lineNumber">828</strong>        this.lastMatch = ['', null];</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>Whenever the browser pops the history state (i.e. when the user goes back with the back button or forward with the forward button), we need to route again.</p>
</div><pre class="source javascript"><strong class="lineNumber">832</strong>        this._cb = () =&#62; this.route(location.pathname);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">833</strong>        window.addEventListener('popstate', this._cb);</pre></div>
<div class="line"><div class="doc"><p>Route the current URL, if it&#39;s already a deep link to a path.</p>
</div><pre class="source javascript"><strong class="lineNumber">835</strong>        this._cb();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">836</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">837</strong></pre></div>
<div class="line"><div class="doc"><p>The &quot;summary&quot; of this Evented (components can bind to this object) is the information about the last route.</p>
</div><pre class="source javascript"><strong class="lineNumber">840</strong>    summarize() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">841</strong>        return this.lastMatch;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">842</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">843</strong></pre></div>
<div class="line"><div class="doc"><p>Click events from links can call <code>this.go()</code> with the destination URL to trigger going to a new route without reloading the page.</p>
</div><pre class="source javascript"><strong class="lineNumber">846</strong>    go(destination) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">847</strong>        history.pushState(null, document.title, destination);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">848</strong>        this.route(destination);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">849</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">850</strong></pre></div>
<div class="line"><div class="doc"><p>Main procedure to reconcile which of the defined route the current location path matches, and dispatch the right event. Routes are checked in order of declaration.</p>
</div><pre class="source javascript"><strong class="lineNumber">854</strong>    route(path) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p>Match destination against the route regular expressions</p>
</div><pre class="source javascript"><strong class="lineNumber">856</strong>        for (const [name, routeRe, paramNames] of this.routes) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">857</strong>            const match = routeRe.exec(path);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">858</strong>            if (match !== null) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">859</strong>                const result = {};</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">860</strong>                const paramValues = match.slice(1);</pre></div>
<div class="line"><div class="doc"><p>Given the matched values and parameter names, build a dictionary of params that components can use to re-render based on the route.</p>
</div><pre class="source javascript"><strong class="lineNumber">864</strong>                paramNames.forEach((name, i) =&#62; result[name] = paramValues[i]);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">865</strong>                this.lastMatch = [name, result];</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">866</strong>                break;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">867</strong>            }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">868</strong>        }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">869</strong>        this.emitEvent();</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">870</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">871</strong></pre></div>
<div class="line"><div class="doc"><p>When we don&#39;t want the router to work anymore / stop listening / be gc&#39;d, we can call <code>#remove()</code> to do just that.</p>
</div><pre class="source javascript"><strong class="lineNumber">874</strong>    remove() {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">875</strong>        window.removeEventListener('popstate', this._cb);</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">876</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">877</strong></pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">878</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">879</strong></pre></div>
<div class="line"><div class="doc"><p>Torus exposes these public APIs</p>
</div><pre class="source javascript"><strong class="lineNumber">881</strong>const exposedNames = {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber"></strong></pre></div>
<div class="line"><div class="doc"><p><code>renderJDOM</code> isn&#39;t designed to be a public API and the API might change, but it&#39;s exposed to make unit testing easier.</p>
</div><pre class="source javascript"><strong class="lineNumber">884</strong>    renderJDOM,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">885</strong>    Component,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">886</strong>    Styled,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">887</strong>    StyledComponent,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">888</strong>    List,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">889</strong>    ListOf,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">890</strong>    Record,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">891</strong>    Store,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">892</strong>    StoreOf,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">893</strong>    Router,</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">894</strong>}</pre></div>
<div class="line"><div class="doc"><p>If there is a global <code>window</code> object, bind API names to it.</p>
</div><pre class="source javascript"><strong class="lineNumber">896</strong>if (typeof window === 'object') {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">897</strong>    for (const name in exposedNames) {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">898</strong>        window[name] = exposedNames[name];</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">899</strong>    }</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">900</strong>}</pre></div>
<div class="line"><div class="doc"><p>Export public APIs CommonJS-style</p>
</div><pre class="source javascript"><strong class="lineNumber">902</strong>if (typeof module === 'object' &#38;&#38; typeof module.exports === 'object') {</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">903</strong>    module.exports = exposedNames;</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">904</strong>}</pre></div>
<div class="line"><div class="doc"></div><pre class="source javascript"><strong class="lineNumber">905</strong></pre></div>
    </main>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/github-gist.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
    <script>
        for (const el of document.querySelectorAll('.line pre')) {
            hljs.highlightBlock(el);
        }
    </script>
</body>

</html>